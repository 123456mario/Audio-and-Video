# test_send_wing.py: Wing ì‹œë®¬ë ˆì´ì…˜ â€“ OSC ë°ì´í„° ì „ì†¡ (ë””ë²„ê¹… + ì—°ê²° í™•ì¸)

from pythonosc import udp_client
import time
import sys
import socket  # í¬íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸ìš©

# bridgeì˜ OSC ì„œë²„ IP/í¬íŠ¸
BRIDGE_IP = "192.168.1.9"  # ë§¥ë¶ IP (ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸ìš©, RPi ì‹œ RPi IP)
BRIDGE_PORT = 50000

# í¬íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸ (bridge ë¦¬ìŠ¤ë‹ í™•ì¸)
def check_bridge_connection(ip, port):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)  # UDP for OSC
        s.settimeout(1)
        s.sendto(b"test", (ip, port))  # ê°„ë‹¨ íŒ¨í‚· ë³´ë‚´ê¸° (ì‘ë‹µ ì—†ì–´ë„ ì—°ê²° ì‹œë„)
        s.close()
        print(f"âœ… bridge ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: {ip}:{port} (íŒ¨í‚· ì „ì†¡ ê°€ëŠ¥)")
        return True
    except Exception as e:
        print(f"âŒ bridge ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {ip}:{port} â€“ {e} (bridge ì‹¤í–‰ í™•ì¸, lsof -i :{port})")
        return False

# í´ë¼ì´ì–¸íŠ¸ ìƒì„± + í…ŒìŠ¤íŠ¸
try:
    if not check_bridge_connection(BRIDGE_IP, BRIDGE_PORT):
        sys.exit(1)
    client = udp_client.SimpleUDPClient(BRIDGE_IP, BRIDGE_PORT)
    print(f"âœ… OSC í´ë¼ì´ì–¸íŠ¸ ìƒì„±: {BRIDGE_IP}:{BRIDGE_PORT} (ë””ë²„ê¹… ëª¨ë“œ)")
except Exception as e:
    print(f"âŒ OSC í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì˜¤ë¥˜: {e}")
    sys.exit(1)

# CH1 íŒ¨ìŠ¤
PATHS = {
    "ch1_mute": "/ch/01/mute",
    "ch1_vol": "/ch/01/fader",
}

print("ğŸ§ª Wing ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘: OSC ë°ì´í„° ì „ì†¡ (ë””ë²„ê¹… ëª¨ë“œ)...")
print("   - bridge ì‹¤í–‰ ì¤‘ í™•ì¸ (lsof -i :50000). íŒŒì¼ ë¡œê·¸: tail -f /tmp/bridge_debug.log")

def send_subscribe_renew():
    print("\n--- êµ¬ë… renew ëª¨ì˜ (ë””ë²„ê¹…) ---")
    try:
        client.send_message("/ch/01/mute s~renew", [8])
        print(f"ğŸ“¡ renew ì „ì†¡ ì™„ë£Œ: /ch/01/mute s~renew [8] (bridge ë¡œê·¸ í™•ì¸)")
        time.sleep(1)
        client.send_message("/ch/01/fader s~renew", [8])
        print(f"ğŸ“¡ renew ì „ì†¡ ì™„ë£Œ: /ch/01/fader s~renew [8]")
    except Exception as e:
        print(f"âŒ renew ì „ì†¡ ì˜¤ë¥˜: {e}")

def send_ch1_data():
    print("\n--- CH1 ë°ì´í„° ì „ì†¡ (ë””ë²„ê¹…) ---")
    try:
        client.send_message(PATHS["ch1_mute"], 1.0)
        print(f"ğŸ“¤ ì „ì†¡ ì™„ë£Œ: {PATHS['ch1_mute']} = 1.0 (bridge 'ğŸµ OSC ìˆ˜ì‹ ' ë¡œê·¸ í™•ì¸)")
        time.sleep(2)

        client.send_message(PATHS["ch1_vol"], 0.444)
        print(f"ğŸ“¤ ì „ì†¡ ì™„ë£Œ: {PATHS['ch1_vol']} = 0.444 (bridge 'ğŸ”„ VOL ë³€í™˜' ë¡œê·¸ í™•ì¸)")
        time.sleep(2)

        client.send_message(PATHS["ch1_mute"], 0.0)
        print(f"ğŸ“¤ ì „ì†¡ ì™„ë£Œ: {PATHS['ch1_mute']} = 0.0")
        time.sleep(2)

        client.send_message(PATHS["ch1_vol"], 1.0)
        print(f"ğŸ“¤ ì „ì†¡ ì™„ë£Œ: {PATHS['ch1_vol']} = 1.0 (Xilica í‘¸ì‹œ ë¡œê·¸ í™•ì¸)")
    except Exception as e:
        print(f"âŒ ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜: {e}")

if __name__ == "__main__":
    send_subscribe_renew()
    send_ch1_data()
    print("\n--- í…ŒìŠ¤íŠ¸ ì™„ë£Œ ---")
    print("bridge ì½˜ì†”/íŒŒì¼ ë¡œê·¸ (/tmp/bridge_debug.log) í™•ì¸: 'âœ…'ì™€ 'ğŸ“¤ í‘¸ì‹œ' ë‚˜ì™€ì•¼ í•¨.")
    input("Enterë¡œ ì¬ì‹¤í–‰...")
